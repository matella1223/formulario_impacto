<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Registro y mรฉtricas - Asociaciรณn</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>

<style>
:root{
ย ย --bg: #f3f4f6; /* Gris muy claro */
ย ย --card: #ffffff;
ย ย --accent: #2563eb; /* Azul primario */
ย ย --accent-dark: #1e40af;
ย ย --muted: #6b7280;
ย ย --border: #e5e7eb;
ย ย --shadow-light: rgba(255, 255, 255, 0.7);
ย ย --shadow-dark: rgba(0, 0, 0, 0.08);

ย ย font-family: 'Inter', sans-serif;
ย ย font-size: 16px;
}
body{ margin:0; background:var(--bg); color:#1f2937; line-height:1.5; }
.container{ max-width:1200px; margin:32px auto; padding:0 20px; }
header{ display:flex; gap:16px; align-items:center; margin-bottom:24px; padding:16px; border-bottom:1px solid var(--border); }
header h1{ margin:0; font-size:24px; font-weight:700; color:#111827; }
header p{ margin:0; color:var(--muted); font-size:14px; }
.grid{ display:grid; grid-template-columns: 1fr 400px; gap:24px; align-items:start; }
h3{ font-size:18px; font-weight:600; color:#111827; margin-top:0; margin-bottom:12px; border-bottom:1px solid var(--border); padding-bottom:8px; }

/* Estilo de tarjeta con Neumorfismo Suave */
.card{ย
ย ย background:var(--card);ย
ย ย border-radius:16px;ย
ย ย padding:20px;ย
ย ย box-shadow:ย
ย ย ย ย 9px 9px 16px var(--shadow-dark),ย
ย ย ย ย -9px -9px 16px var(--shadow-light);
ย ย transition: all 0.3s ease;
}

/* Formularios */
.row{ display:flex; gap:12px; margin-bottom:10px; }
label{ display:block; font-size:13px; color:var(--muted); margin-bottom:4px; font-weight:600; }
input:not([type="checkbox"]):not([type="radio"]), select, textarea{
ย ย width:100%; padding:10px 12px; border-radius:10px;ย
ย ย border:none;ย
ย ย box-shadow: inset 2px 2px 5px rgba(0,0,0,0.05), inset -2px -2px 5px rgba(255,255,255,0.7);
ย ย background-color: var(--bg);
ย ย box-sizing:border-box;
ย ย font-size:15px;
ย ย transition: all 0.2s ease;
}
input:focus, select:focus, textarea:focus {
ย ย outline: none;
ย ย background-color: var(--card);
ย ย box-shadow:ย
ย ย ย ย 0 0 0 2px var(--accent-dark),
ย ย ย ย inset 2px 2px 5px rgba(0,0,0,0.05);
}
textarea{ min-height:80px; resize:vertical; }

/* Botones */
button{ย
ย ย background:var(--accent); color:white; border:none;ย
ย ย padding:10px 16px; border-radius:10px; cursor:pointer;ย
ย ย font-weight:600; font-size:15px;
ย ย box-shadow: 3px 3px 6px rgba(0,0,0,0.1), -3px -3px 6px rgba(255,255,255,0.7);
ย ย transition: all 0.2s ease;
}
button:hover{ background:var(--accent-dark); }
button:active{ย
ย ย box-shadow: inset 3px 3px 6px rgba(0,0,0,0.1), inset -3px -3px 6px rgba(255,255,255,0.7);
}
button.secondary{ย
ย ย background:var(--bg); color:#111827;ย
ย ย box-shadow: 3px 3px 6px rgba(0,0,0,0.05), -3px -3px 6px rgba(255,255,255,0.7);
}
button.secondary:hover{ background:#dadce1; }

.small{ font-size:13px; color:var(--muted); }

/* Tablas */
table{ width:100%; border-collapse:collapse; font-size:14px; margin-top:10px; }
th{ background-color: var(--bg); color:#111827; font-weight:700; }
th, td{ padding:10px 12px; border-bottom:1px solid var(--border); text-align:left; vertical-align:middle; }
td:last-child { color: var(--muted); } /* Observaciones */
#tableRegs th { position: sticky; top: 0; z-index: 1; }

/* KPIs */
.kpi-row{ display:flex; gap:16px; flex-wrap:wrap; margin-bottom:16px; }
.kpi{ย
ย ย background:var(--card);ย
ย ย border-radius:12px;ย
ย ย padding:14px;ย
ย ย min-width:120px;ย
ย ย flex-grow:1;
ย ย text-align:center;
ย ย box-shadow: 0 4px 8px rgba(0,0,0,0.05);
}
.kpi .num{ font-size:24px; font-weight:700; color:var(--accent); margin-bottom:4px; }
.kpi .label{ font-size:12px; color:var(--muted); font-weight:500; }

.controls{ display:flex; gap:10px; flex-wrap:wrap; margin-top:12px; }

/* Grรกficos */
.chart-container{ height:250px; width:100%; margin-top:16px; }

/* Responsive */
@media (max-width:1024px){ย
ย ย .grid{ grid-template-columns: 1fr; }ย
ย ย .card { padding:16px; }ย
ย ย .row { display: block; }
ย ย .row > div { margin-bottom: 10px; }
}
@media (max-width:600px){
ย ย .kpi-row { justify-content: space-around; }
ย ย .kpi { min-width: unset; width: 45%; }
}
</style>
</head>
<body>
<div class="container">
ย ย <header>
ย ย ย ย <div>
ย ย ย ย ย ย <h1>๐ Registro de actividades y mรฉtricas โ Asociaciรณn</h1>
ย ย ย ย ย ย <p>Plataforma para recoger datos de talleres, participantes y mรฉtricas de comunicaciรณn.</p>
ย ย ย ย </div>
ย ย </header>

ย ย <div class="grid">
ย ย ย ย <div>
ย ย ย ย ย ย <div class="card" id="formCard">
ย ย ย ย ย ย ย ย <h3>๐ Registrar Participante / Sesiรณn</h3>
ย ย ย ย ย ย ย ย <form id="entryForm">
ย ย ย ย ย ย ย ย ย ย <div class="row">
ย ย ย ย ย ย ย ย ย ย ย ย <div style="flex:1;">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <label for="fecha">Fecha</label>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <input type="date" id="fecha" required />
ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย <div style="flex:2;">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <label for="taller">Nombre del taller/sesiรณn</label>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <input type="text" id="taller" placeholder="Ej. Taller de juego y resiliencia" required />
ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย </div>

ย ย ย ย ย ย ย ย ย ย <div class="row">
ย ย ย ย ย ย ย ย ย ย ย ย <div style="flex:1;">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <label for="lugar">Lugar / Barrio</label>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <input type="text" id="lugar" placeholder="Ej. Centro cรญvico X" />
ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย <div style="flex:1;">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <label for="edad">Edad / tramo</label>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <select id="edad">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <option value="">-- Seleccionar --</option>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <option>0-5</option><option>6-12</option><option>13-17</option><option>18-30</option><option>31-60</option><option>60+</option>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย </select>
ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย <div style="flex:1;">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <label for="tipoPublico">Tipo pรบblico</label>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <select id="tipoPublico">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <option value="">-- Seleccionar --</option>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <option>Afectado DANA</option>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <option>Familia</option>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <option>Colectivo estigmatizado</option>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <option>Comunidad local</option>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <option>Otro</option>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย </select>
ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย </div>

ย ย ย ย ย ย ย ย ย ย <div class="row">
ย ย ย ย ย ย ย ย ย ย ย ย <div style="flex:1;">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <label for="como">Cรณmo se enterรณ</label>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <select id="como">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <option value="">-- Seleccionar --</option>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <option>Boca a boca</option>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <option>Web</option>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <option>Redes sociales</option>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <option>Instituciรณn</option>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <option>Flyer / Cartel</option>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <option>Otro</option>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย </select>
ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย <div style="flex:1;">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <label for="repite">ยฟRepite?</label>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <select id="repite">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <option value="">-- --</option>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <option>Sรญ</option><option>No</option>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย </select>
ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย <div style="flex:1;">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <label for="voluntario">Voluntario</label>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <select id="voluntario">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <option value="">-- --</option>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <option>Sรญ</option><option>No</option>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย </select>
ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย <div style="flex:1;">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <label for="horasVol">Horas voluntario</label>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <input type="number" id="horasVol" min="0" step="0.5" placeholder="0" value="0"/>
ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย </div>

ย ย ย ย ย ย ย ย ย ย <div class="row" style="margin-top:12px; padding-top:10px; border-top:1px dashed var(--border);">
ย ย ย ย ย ย ย ย ย ย ย ย <div style="flex:1;">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <label for="satisf">Satisfacciรณn (1-5)</label>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <input type="number" id="satisf" min="1" max="5" value="5" />
ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย <div style="flex:1;">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <label for="bienAntes">Bienestar antes (1-5)</label>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <input type="number" id="bienAntes" min="1" max="5" value="3" />
ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย <div style="flex:1;">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <label for="bienDespues">Bienestar despuรฉs (1-5)</label>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <input type="number" id="bienDespues" min="1" max="5" value="4" />
ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย </div>

ย ย ย ย ย ย ย ย ย ย <div class="row" style="margin-top:10px;">
ย ย ย ย ย ย ย ย ย ย ย ย <div style="flex:1;">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <label for="nombre">Nombre participante (opcional)</label>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <input type="text" id="nombre" placeholder="Nombre o iniciales" />
ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย </div>

ย ย ย ย ย ย ย ย ย ย <div style="margin-top:10px;">
ย ย ย ย ย ย ย ย ย ย ย ย <label for="obs">Observaciones</label>
ย ย ย ย ย ย ย ย ย ย ย ย <textarea id="obs" placeholder="Notas breves sobre la sesiรณn o el participante..."></textarea>
ย ย ย ย ย ย ย ย ย ย </div>

ย ย ย ย ย ย ย ย ย ย <div style="display:flex;gap:10px;margin-top:20px;align-items:center; justify-content: flex-end;">
ย ย ย ย ย ย ย ย ย ย ย ย <div class="small" style="margin-right:auto;">ยกGuardarรก directamente en tu Google Sheet!</div>
ย ย ย ย ย ย ย ย ย ย ย ย <button type="button" class="secondary" id="clearFormBtn">Limpiar</button>
ย ย ย ย ย ย ย ย ย ย ย ย <button type="submit">Guardar registro</button>
ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย </form>
ย ย ย ย ย ย </div>

ย ย ย ย ย ย <div class="card" style="margin-top:24px;">
ย ย ย ย ย ย ย ย <h3>Lista de Registros (Local)</h3>
ย ย ย ย ย ย ย ย <p class="small">โ๏ธ Esta tabla y los botones debajo solo muestran datos antiguos guardados en tu navegador (LocalStorage), **no** el contenido de tu Google Sheet.</p>
ย ย ย ย ย ย ย ย <div class="controls">
ย ย ย ย ย ย ย ย ย ย <button id="exportCsv">Exportar a CSV (Local)</button>
ย ย ย ย ย ย ย ย ย ย <button id="clearAll" class="secondary">โ๏ธ Borrar registros locales</button>
ย ย ย ย ย ย ย ย </div>

ย ย ย ย ย ย ย ย <div style="margin-top:12px; overflow:auto; max-height:450px; border:1px solid var(--border); border-radius:10px;">
ย ย ย ย ย ย ย ย ย ย <table id="tableRegs">
ย ย ย ย ย ย ย ย ย ย ย ย <thead>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <tr>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <th>Fecha</th><th>Taller</th><th>Tipo</th><th>Cรณmo</th><th>Satisf.</th><th>Bienestar ฮ</th><th>Vol.</th><th title="Observaciones">Obs</th>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย </tr>
ย ย ย ย ย ย ย ย ย ย ย ย </thead>
ย ย ย ย ย ย ย ย ย ย ย ย <tbody></tbody>
ย ย ย ย ย ย ย ย ย ย </table>
ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย </div>
ย ย ย ย </div>

ย ย ย ย <div>
ย ย ย ย ย ย <div class="card">
ย ย ย ย ย ย ย ย <h3>๐ KPIs Principales (Basado en datos locales)</h3>
ย ย ย ย ย ย ย ย <div class="kpi-row" id="kpiRow">
ย ย ย ย ย ย ย ย ย ย <div class="kpi">
ย ย ย ย ย ย ย ย ย ย ย ย <div class="num" id="k_totalWorkshops">0</div>
ย ย ย ย ย ย ย ย ย ย ย ย <div class="label">Participantes (registros)</div>
ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย <div class="kpi">
ย ย ย ย ย ย ย ย ย ย ย ย <div class="num" id="k_avgSatisf">0</div>
ย ย ย ย ย ย ย ย ย ย ย ย <div class="label">Satisf. media (1-5)</div>
ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย <div class="kpi">
ย ย ย ย ย ย ย ย ย ย ย ย <div class="num" id="k_avgImpro">0</div>
ย ย ย ย ย ย ย ย ย ย ย ย <div class="label">Mejora bienestar (ฮ)</div>
ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย <div class="kpi">
ย ย ย ย ย ย ย ย ย ย ย ย <div class="num" id="k_repeatRate">0%</div>
ย ย ย ย ย ย ย ย ย ย ย ย <div class="label">Tasa de repeticiรณn</div>
ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย <div class="kpi">
ย ย ย ย ย ย ย ย ย ย ย ย <div class="num" id="k_volHours">0</div>
ย ย ย ย ย ย ย ย ย ย ย ย <div class="label">Horas voluntariado</div>
ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย </div>

ย ย ย ย ย ย ย ย <button id="reloadKPIs" class="secondary" style="width:100%; margin-bottom:12px;">Actualizar Mรฉtricas y Grรกficos (Solo datos locales)</button>

ย ย ย ย ย ย ย ย <h4 style="font-size:16px; font-weight:600; margin-top:16px; margin-bottom:8px;">Grรกficos Clave</h4>
ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย <div class="chart-container">
ย ย ย ย ย ย ย ย ย ย <canvas id="chartSource"></canvas>
ย ย ย ย ย ย ย ย ย ย <p class="small" style="text-align: center; margin-top: -10px;">Fuente de entrada</p>
ย ย ย ย ย ย ย ย </div>

ย ย ย ย ย ย ย ย <div class="chart-container">
ย ย ย ย ย ย ย ย ย ย <canvas id="chartSatisf"></canvas>
ย ย ย ย ย ย ย ย ย ย <p class="small" style="text-align: center; margin-top: -10px;">Satisfacciรณn media por taller (Top 8)</p>
ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย </div>

ย ย ย ย ย ย <div class="card" style="margin-top:24px;">
ย ย ย ย ย ย ย ย <h3>๐ฐ Mรฉtricas de Comunicaciรณn (Entrada Manual Local)</h3>
ย ย ย ย ย ย ย ย <form id="comForm">
ย ย ย ย ย ย ย ย ย ย <div class="row">
ย ย ย ย ย ย ย ย ย ย ย ย <div style="flex:1;">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <label for="periodo">Periodo (ej. 2025-Q3)</label>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <input type="text" id="periodo" placeholder="2025-Q3" required />
ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย <div style="flex:1;">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <label for="visitasWeb">Visitas web</label>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <input type="number" id="visitasWeb" min="0" placeholder="0" value="0"/>
ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย </div>

ย ย ย ย ย ย ย ย ย ย <div class="row">
ย ย ย ย ย ย ย ย ย ย ย ย <div style="flex:1;">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <label for="alcance">Alcance redes (impresiones)</label>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <input type="number" id="alcance" min="0" placeholder="0" value="0"/>
ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย <div style="flex:1;">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <label for="seguidores">Seguidores nuevos</label>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <input type="number" id="seguidores" min="0" placeholder="0" value="0"/>
ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย </div>

ย ย ย ย ย ย ย ย ย ย <div style="display:flex;gap:10px;margin-top:15px;">
ย ย ย ย ย ย ย ย ย ย ย ย <button type="submit">Guardar mรฉtricas</button>
ย ย ย ย ย ย ย ย ย ย ย ย <button type="button" id="exportComCsv" class="secondary">Exportar CSV</button>
ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย </form>

ย ย ย ย ย ย ย ย <div style="margin-top:15px; overflow-x:auto;">
ย ย ย ย ย ย ย ย ย ย <table id="comTable" style="width:100%;">
ย ย ย ย ย ย ย ย ย ย ย ย <thead><tr><th>Periodo</th><th>Visitas</th><th>Alcance</th><th>Seguidores</th></tr></thead>
ย ย ย ย ย ย ย ย ย ย ย ย <tbody></tbody>
ย ย ย ย ย ย ย ย ย ย </table>
ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย </div>
ย ย ย ย </div>
ย ย </div>
</div>

<script>
/* -------------------------
ESTRUCTURA DE DATOS y UTILIDADES (Local Storage)
--------------------------*/
const STORAGE_KEY = 'asoc_registros_v2'; // Clave para registros antiguos/locales
const COMM_KEY = 'asoc_metrica_com_v2'; // Clave para mรฉtricas de comunicaciรณn (Sigue siendo local)

/** Genera un ID รบnico simple. */
function uid(){ return 'id'+Math.random().toString(36).slice(2,9); }

/** Escapa HTML para prevenir XSS. */
function escapeHtml(s){
ย ย return String(s || '').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;');
}

/** Carga los datos de registros (SOLO LOCALES Y ANTIGUOS). */
function loadData(){
ย ย const raw = localStorage.getItem(STORAGE_KEY);
ย ย return raw ? JSON.parse(raw) : [];
}

/** Guarda los datos de registros (SOLO LOCALES Y ANTIGUOS). */
function saveData(arr){
ย ย localStorage.setItem(STORAGE_KEY, JSON.stringify(arr));
}

/** Carga los datos de comunicaciรณn (LOCAL). */
function loadComm(){
ย ย const raw = localStorage.getItem(COMM_KEY);
ย ย return raw ? JSON.parse(raw) : [];
}

/** Guarda los datos de comunicaciรณn (LOCAL). */
function saveComm(arr){
ย ย localStorage.setItem(COMM_KEY, JSON.stringify(arr));
}

/* -------------------------
RENDER TABLA DE REGISTROS (Muestra solo datos locales antiguos)
--------------------------*/
function renderTable(){
ย ย const data = loadData();
ย ย const tbody = document.querySelector('#tableRegs tbody');
ย ย tbody.innerHTML = '';
ย ยย
ย ย // Mostramos los รบltimos registros primero
ย ย data.slice().reverse().forEach(r=>{
ย ย ย ย const tr = document.createElement('tr');
ย ย ย ย const diff = (Number(r.bienDespues)||0) - (Number(r.bienAntes)||0);
ย ย ย ย const diffText = diff > 0 ? `+${diff}` : (diff < 0 ? `${diff}` : '-');

ย ย ย ย tr.innerHTML = `
ย ย ย ย ย ย <td>${r.fecha || '-'}</td>
ย ย ย ย ย ย <td title="${escapeHtml(r.taller)}">${escapeHtml(r.taller).slice(0, 30)}${(r.taller||'').length > 30 ? '...' : ''}</td>
ย ย ย ย ย ย <td>${escapeHtml(r.tipoPublico) || '-'}</td>
ย ย ย ย ย ย <td>${escapeHtml(r.como) || '-'}</td>
ย ย ย ย ย ย <td>${r.satisf || '-'}</td>
ย ย ย ย ย ย <td>${diffText}</td>
ย ย ย ย ย ย <td>${r.voluntario === 'Sรญ' ? (r.horasVol || 'Sรญ') : 'No'}</td>
ย ย ย ย ย ย <td title="${escapeHtml(r.obs||'')}">${(r.obs||'').slice(0,25)}${(r.obs||'').length > 25 ? '...' : ''}</td>
ย ย ย ย `;
ย ย ย ย tbody.appendChild(tr);
ย ย });
}

/* -------------------------
CรLCULO DE KPIs (Usa solo datos locales antiguos)
--------------------------*/
function computeKPIs(){
ย ย const data = loadData();
ย ย const k = { total: 0, avgSatis: 0, avgImpro: 0, repeatRate: 0, volHours: 0 };
ย ย if(data.length === 0) return k;

ย ย let sumS = 0, sumI = 0, repeats = 0, hours = 0;
ย ยย
ย ย data.forEach(r=>{
ย ย ย ย sumS += Number(r.satisf || 0);
ย ย ย ย const before = Number(r.bienAntes || 0);
ย ย ย ย const after = Number(r.bienDespues || 0);
ย ย ย ย sumI += (after - before);
ย ย ย ย if(r.repite === 'Sรญ') repeats++;
ย ย ย ย if(r.voluntario === 'Sรญ') hours += Number(r.horasVol || 0);
ย ย });

ย ย k.total = data.length;
ย ย k.avgSatis = (sumS / data.length);
ย ย k.avgImpro = (sumI / data.length);
ย ย k.repeatRate = (repeats / data.length) * 100;
ย ย k.volHours = hours;
ย ยย
ย ย return k;
}

function updateKPIsAndCharts(){
ย ย const k = computeKPIs();
ย ย document.getElementById('k_totalWorkshops').textContent = k.total.toLocaleString('es-ES');
ย ย document.getElementById('k_avgSatisf').textContent = k.avgSatis ? k.avgSatis.toFixed(2) : '0';
ย ย document.getElementById('k_avgImpro').textContent = k.avgImpro ? k.avgImpro.toFixed(2) : '0';
ย ย document.getElementById('k_repeatRate').textContent = k.repeatRate ? k.repeatRate.toFixed(1)+'%' : '0%';
ย ย document.getElementById('k_volHours').textContent = k.volHours ? k.volHours.toLocaleString('es-ES', { maximumFractionDigits: 1 }) : '0';

ย ย drawSourceChart();
ย ย drawSatisfChart();
}

/* -------------------------
GRรFICOS (Chart.js) - Usan solo datos locales antiguos
--------------------------*/
const baseChartConfig = {
ย ย plugins: {
ย ย ย ย legend: { position: 'bottom', labels: { boxWidth: 10 } },
ย ย ย ย datalabels: { display: false } // Desactivado por defecto
ย ย },
ย ย responsive: true,
ย ย maintainAspectRatio: false,
};

let chartSource = null;
function drawSourceChart(){
ย ย const data = loadData();
ย ย const counts = {};
ย ย data.forEach(r=>{ const key = r.como || 'Desconocido'; counts[key] = (counts[key]||0) + 1; });
ย ย const labels = Object.keys(counts);
ย ย const values = labels.map(l=>counts[l]);
ย ยย
ย ย const ctx = document.getElementById('chartSource').getContext('2d');
ย ย if(chartSource) chartSource.destroy();
ย ยย
ย ย chartSource = new Chart(ctx, {
ย ย ย ย type: 'pie',
ย ย ย ย data: {ย
ย ย ย ย ย ย labels,ย
ย ย ย ย ย ย datasets: [{ย
ย ย ย ย ย ย ย ย data: values,ย
ย ย ย ย ย ย ย ย backgroundColor: ['#2563eb', '#3b82f6', '#60a5fa', '#93c5fd', '#bfdbfe', '#e0f2fe'],
ย ย ย ย ย ย ย ย hoverOffset: 10
ย ย ย ย ย ย }]
ย ย ย ย },
ย ย ย ย options: {
ย ย ย ย ย ย ...baseChartConfig,
ย ย ย ย ย ย plugins: {
ย ย ย ย ย ย ย ย ...baseChartConfig.plugins,
ย ย ย ย ย ย ย ย datalabels: {
ย ย ย ย ย ย ย ย ย ย color: '#fff',
ย ย ย ย ย ย ย ย ย ย formatter: (value, ctx) => {
ย ย ย ย ย ย ย ย ย ย ย ย let sum = ctx.dataset.data.reduce((a, b) => a + b, 0);
ย ย ย ย ย ย ย ย ย ย ย ย let percentage = Math.round((value * 100) / sum) + '%';
ย ย ย ย ย ย ย ย ย ย ย ย return percentage;
ย ย ย ย ย ย ย ย ย ย },
ย ย ย ย ย ย ย ย ย ย display: 'auto'
ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย }
ย ย ย ย },
ย ย ย ย plugins: [ChartDataLabels]
ย ย });
}

let chartSatisf = null;
function drawSatisfChart(){
ย ย const data = loadData();
ย ย const byTaller = {};
ย ย data.forEach(r=>{
ย ย ย ย const t = r.taller || 'Sin nombre';
ย ย ย ย if(!byTaller[t]) byTaller[t] = {sum:0,count:0};
ย ย ย ย byTaller[t].sum += Number(r.satisf||0);
ย ย ย ย byTaller[t].count += 1;
ย ย });
ย ยย
ย ย const entries = Object.entries(byTaller).map(([t,o])=>({t,avg: o.sum / o.count, count:o.count}));
ย ย entries.sort((a,b)=>b.count - a.count); // Ordenar por cantidad de registros
ย ยย
ย ย const top = entries.slice(0,8);
ย ย const labels = top.map(e=>e.t.slice(0, 30)); // Limitar el texto de la etiqueta
ย ย const values = top.map(e=> Number(e.avg.toFixed(2)) );
ย ยย
ย ย const ctx = document.getElementById('chartSatisf').getContext('2d');
ย ย if(chartSatisf) chartSatisf.destroy();
ย ยย
ย ย chartSatisf = new Chart(ctx, {
ย ย ย ย type: 'bar',
ย ย ย ย data: {ย
ย ย ย ย ย ย labels,ย
ย ย ย ย ย ย datasets: [{ย
ย ย ย ย ย ย ย ย label: 'Satisf. media',ย
ย ย ย ย ย ย ย ย data: values,
ย ย ย ย ย ย ย ย backgroundColor: '#34d399', // Verde atractivo
ย ย ย ย ย ย ย ย borderColor: '#10b981',
ย ย ย ย ย ย ย ย borderWidth: 1
ย ย ย ย ย ย }]
ย ย ย ย },
ย ย ย ย options: {
ย ย ย ย ย ย ...baseChartConfig,
ย ย ย ย ย ย indexAxis: 'y',
ย ย ย ย ย ย plugins: {
ย ย ย ย ย ย ย ย ...baseChartConfig.plugins,
ย ย ย ย ย ย ย ย legend: { display: false },
ย ย ย ย ย ย ย ย datalabels: {
ย ย ย ย ย ย ย ย ย ย anchor: 'end',
ย ย ย ย ย ย ย ย ย ย align: 'right',
ย ย ย ย ย ย ย ย ย ย color: '#1f2937',
ย ย ย ย ย ย ย ย ย ย formatter: (value) => value.toFixed(2)
ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย },
ย ย ย ย ย ย scales: {
ย ย ย ย ย ย ย ย x: { beginAtZero: true, max: 5 },
ย ย ย ย ย ย ย ย y: { ticks: { autoSkip: false } }
ย ย ย ย ย ย }
ย ย ย ย },
ย ย ย ย plugins: [ChartDataLabels]
ย ย });
}

/* -------------------------
UTILS: CSV export
--------------------------*/
function exportToCsv(filename, rows) {
ย ย if(!rows || rows.length === 0) { alert('No hay datos para exportar'); return; }
ย ยย
ย ย const headers = Object.keys(rows[0]);
ย ย // Funciรณn para manejar comas y saltos de lรญnea dentro de los campos
ย ย const processField = (value) => {
ย ย ย ย const str = String(value ?? '');
ย ย ย ย if (str.includes(',') || str.includes('"') || str.includes('\n')) {
ย ย ย ย ย ย return `"${str.replaceAll('"', '""')}"`;
ย ย ย ย }
ย ย ย ย return str;
ย ย };

ย ย const csv = [headers.join(',')].concat(
ย ย ย ย rows.map(r => headers.map(h => processField(r[h])).join(','))
ย ย ).join('\n'); // Usar \n para mejor compatibilidad

ย ย const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
ย ย const link = document.createElement("a");
ย ย link.href = URL.createObjectURL(blob);
ย ย link.setAttribute('download', filename);
ย ย document.body.appendChild(link);
ย ย link.click();
ย ย document.body.removeChild(link);
}

/* -------------------------
EVENTOS del formulario de REGISTRO: ENVรO A GOOGLE SHEETS
--------------------------*/

// โ๏ธ โ๏ธ โ๏ธ ยกCRรTICO! DEBES PEGAR TU URL REAL DE GOOGLE APPS SCRIPT AQUร. โ๏ธ โ๏ธ โ๏ธ
const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbz-c2-nqz88mHtUkd8WcIA4r4jx71Hm0t0aMyNqM_ftXzUXaGajp7F4EM9vpr62EvU11g/exec';

document.getElementById('entryForm').addEventListener('submit', function(ev){
ย ย ev.preventDefault();
ย ยย
ย ย // 1. Recolecciรณn de datos
ย ย const rec = {
ย ย ย ย id: uid(),ย
ย ย ย ย fecha: document.getElementById('fecha').value,
ย ย ย ย taller: document.getElementById('taller').value.trim(),
ย ย ย ย lugar: document.getElementById('lugar').value.trim(),
ย ย ย ย edad: document.getElementById('edad').value,
ย ย ย ย tipoPublico: document.getElementById('tipoPublico').value,
ย ย ย ย como: document.getElementById('como').value,
ย ย ย ย repite: document.getElementById('repite').value,
ย ย ย ย voluntario: document.getElementById('voluntario').value,
ย ย ย ย horasVol: Number(document.getElementById('horasVol').value) || 0,
ย ย ย ย satisf: Number(document.getElementById('satisf').value) || 0,
ย ย ย ย bienAntes: Number(document.getElementById('bienAntes').value) || 0,
ย ย ย ย bienDespues: Number(document.getElementById('bienDespues').value) || 0,
ย ย ย ย nombre: document.getElementById('nombre').value.trim(),
ย ย ย ย obs: document.getElementById('obs').value.trim()
ย ย };
ย ยย
ย ย // 2. Validaciรณn simple
ย ย if (!rec.fecha || !rec.taller) {
ย ย ย ย alert('Por favor, completa la Fecha y el Nombre del taller.');
ย ย ย ย return;
ย ย }

ย ย // Desactivar el botรณn mientras se envรญa
ย ย const submitButton = this.querySelector('button[type="submit"]');
ย ย submitButton.disabled = true;
ย ย submitButton.textContent = 'Enviando...';


ย ย // 3. Envรญo de datos al Apps Script (Google Sheets)
ย ย fetch(APPS_SCRIPT_URL, {
ย ย ย ย method: 'POST',
ย ย ย ย // 'no-cors' es necesario para que funcione con el servidor de Google Apps Script
ย ย ย ย mode: 'no-cors',ย
ย ย ย ย headers: { 'Content-Type': 'application/json' },
ย ย ย ย body: JSON.stringify(rec)
ย ย })
ย ย .then(response => {
ย ย ย ย // Si la conexiรณn tiene รฉxito (no-cors no nos da el status real de Google Sheets)
ย ย ย ย console.log("Peticiรณn POST enviada a Google Sheets. Revisa tu hoja.");

ย ย ย ย // Limpieza y feedback
ย ย ย ย this.reset();
ย ย ย ย document.getElementById('fecha').value = new Date().toISOString().slice(0,10);
ย ย ย ย alert('โ Registro enviado con รฉxito al Google Sheet.');

ย ย ย ย // Recargar la pรกgina para evitar que la gente pulse dos veces
ย ย ย ย window.location.reload();ย
ย ย })
ย ย .catch(error => {
ย ย ย ย // Manejo de error de red
ย ย ย ย console.error('Error al enviar los datos:', error);
ย ย ย ย alert('โ ERROR: No se pudo conectar con el servidor de Google. Revisa tu URL de Apps Script.');
ย ย })
ย ย .finally(() => {
ย ย ย ย // Esto solo se ejecutarรก si la recarga de pรกgina falla
ย ย ย ย submitButton.disabled = false;
ย ย ย ย submitButton.textContent = 'Guardar registro';
ย ย });
});

document.getElementById('clearFormBtn').addEventListener('click', function(){
ย ย document.getElementById('entryForm').reset();
ย ย document.getElementById('fecha').value = new Date().toISOString().slice(0,10); // Restablecer fecha
});

document.getElementById('clearAll').addEventListener('click', function(){
ย ย // Borra solo los datos LOCALES viejos.
ย ย if(confirm('๐จ ยกATENCIรN! ยฟBorrar TODOS los registros LOCALES (en tu navegador)? Los datos en Google Sheets NO se verรกn afectados.')){
ย ย ย ย localStorage.removeItem(STORAGE_KEY);
ย ย ย ย alert('๐๏ธ Todos los registros locales borrados. La fuente de datos principal es Google Sheets.');
ย ย ย ย window.location.reload(); // Recargar para limpiar la vista.
ย ย }
});

document.getElementById('exportCsv').addEventListener('click', function(){
ย ย // Exporta solo los datos LOCALES viejos.
ย ย const data = loadData();
ย ย exportToCsv('registros_asociacion_LOCAL.csv', data);
ย ย alert('Exportando datos antiguos guardados LOCALMENTE. La fuente de datos principal es Google Sheets.');
});

/* -------------------------
COMUNICACIรN - MรTRICAS MANUALES (LOCALES)
--------------------------*/
document.getElementById('comForm').addEventListener('submit', function(ev){
ย ย ev.preventDefault();
ย ย const rec = {
ย ย ย ย id: uid(),
ย ย ย ย periodo: document.getElementById('periodo').value.trim() || (new Date().getFullYear() + '-N/A'),
ย ย ย ย visitasWeb: Number(document.getElementById('visitasWeb').value) || 0,
ย ย ย ย alcance: Number(document.getElementById('alcance').value) || 0,
ย ย ย ย seguidores: Number(document.getElementById('seguidores').value) || 0
ย ย };
ย ยย
ย ย const arr = loadComm();
ย ย arr.push(rec);
ย ย saveComm(arr);
ย ย renderCommTable();
ย ย this.reset();
ย ย alert('โ Mรฉtricas guardadas localmente.');
});

document.getElementById('exportComCsv').addEventListener('click', function(){
ย ย const arr = loadComm();
ย ย exportToCsv('metrica_comunicacion.csv', arr);
});

function renderCommTable(){
ย ย const arr = loadComm();
ย ย const tbody = document.querySelector('#comTable tbody');
ย ย tbody.innerHTML = '';
ย ย // Mostramos los รบltimos primero
ย ย arr.slice().reverse().forEach(r=>{
ย ย ย ย const tr = document.createElement('tr');
ย ย ย ย tr.innerHTML = `
ย ย ย ย ย ย <td>${escapeHtml(r.periodo)}</td>
ย ย ย ย ย ย <td>${r.visitasWeb.toLocaleString('es-ES')}</td>
ย ย ย ย ย ย <td>${r.alcance.toLocaleString('es-ES')}</td>
ย ย ย ย ย ย <td>${r.seguidores.toLocaleString('es-ES')}</td>
ย ย ย ย `;
ย ย ย ย tbody.appendChild(tr);
ย ย });
}

/* -------------------------
INICIALIZACIรN
--------------------------*/
function init(){
ย ย // Establecer fecha por defecto a hoy
ย ย document.getElementById('fecha').value = new Date().toISOString().slice(0,10);
ย ย 
ย ย // Estas funciones ahora solo cargan datos antiguos de localStorage
ย ย renderTable(); 
ย ย renderCommTable();
ย ย updateKPIsAndCharts();
}
init();

/* -------------------------
FUNCIONALIDAD ADICIONAL
--------------------------*/
document.getElementById('reloadKPIs').addEventListener('click', updateKPIsAndCharts);

/* -------------------------
FIN SCRIPT
--------------------------*/
</script>
</body>

</html>
